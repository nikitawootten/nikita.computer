<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Packaging Node Applications in Nix using Yarn2Nix &#183; nikita.computer</title><meta name=title content="Packaging Node Applications in Nix using Yarn2Nix &#183; nikita.computer"><meta name=description content="I recently rediscovered Nix, the confusingly named trifecta of language, package manager, and build system (oh, and an operating system but at least it has a slightly distinct name!"><link rel=canonical href=https://nikita.computer/posts/packaging-node-applications-in-nix/><link type=text/css rel=stylesheet href=/css/main.bundle.min.17fc506b1c26b1bbc9a782ffffc510d9ecbfef39adb801fd6c673c614f713ffe.css integrity="sha256-F/xQaxwmsbvJp4L//8UQ2ey/7zmtuAH9bGc8YU9xP/4="><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.75206d23ef83f4908b2bdd2317bf6ddff399e9173a16fff5451c40b8e857cfa8.js integrity="sha256-dSBtI++D9JCLK90jF79t3/OZ6Rc6Fv/1RRxAuOhXz6g=" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Packaging Node Applications in Nix using Yarn2Nix"><meta property="og:description" content="I recently rediscovered Nix, the confusingly named trifecta of language, package manager, and build system (oh, and an operating system but at least it has a slightly distinct name!"><meta property="og:type" content="article"><meta property="og:url" content="https://nikita.computer/posts/packaging-node-applications-in-nix/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-08T09:15:40-05:00"><meta property="article:modified_time" content="2023-04-08T09:15:40-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Packaging Node Applications in Nix using Yarn2Nix"><meta name=twitter:description content="I recently rediscovered Nix, the confusingly named trifecta of language, package manager, and build system (oh, and an operating system but at least it has a slightly distinct name!"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Packaging Node Applications in Nix using Yarn2Nix","headline":"Packaging Node Applications in Nix using Yarn2Nix","abstract":"I recently rediscovered Nix, the confusingly named trifecta of language, package manager, and build system (oh, and an operating system but at least it has a slightly distinct name!","inLanguage":"en","url":"https:\/\/nikita.computer\/posts\/packaging-node-applications-in-nix\/","author":{"@type":"Person","name":"Nikita Wootten"},"copyrightYear":"2023","dateCreated":"2023-04-08T09:15:40-05:00","datePublished":"2023-04-08T09:15:40-05:00","dateModified":"2023-04-08T09:15:40-05:00","keywords":["nix","flakes","nodejs"],"mainEntityOfPage":"true","wordCount":"1588"}]</script><meta name=author content="Nikita Wootten"><link href=mailto:stdin@nikita.computer rel=me><link href=https://github.com/nikitawootten rel=me><link href=https://www.linkedin.com/in/nikita-wootten/ rel=me><link href=https://mstdn.social/@nikitaw rel=me><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "c8303eac703c45b89db3207660f3a5a3"}'></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="z-40 flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>nikita.computer</a></div><label id=menu-button for=menu-controller class="block sm:hidden"><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"><ul class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 ltr:text-right rtl:text-left sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"><li class=mb-1><span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class="group mb-1"><a href=/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="group mb-1"><button id=search-button-m0 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span></button></li></ul></div></label><ul class="hidden list-none flex-row ltr:text-right rtl:text-left sm:flex"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><button id=search-button-m1 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/></a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/packaging-node-applications-in-nix/>Packaging Node Applications in Nix using Yarn2Nix</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Packaging Node Applications in Nix using Yarn2Nix</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2023-04-08 09:15:40 -0500 -0500">8 April 2023</time><span class="px-2 text-primary-500">&#183;</span><span>1588 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/nikitawootten/nikitawootten.github.io/ class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title="Edit content"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M490.3 40.4c21.9 21.87 21.9 57.33.0 79.2l-30 30.1-98-97.98 30.1-30.06C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7 339.7 74.34l98 97.96L270.3 339.6C264.2 345.8 256.7 350.4 248.4 353.2l-88.8 29.6C150.1 385.6 141.5 383.4 135 376.1 128.6 370.5 126.4 361 129.2 352.4l29.6-88.8C161.6 255.3 166.2 247.8 172.4 241.7v0zM192 63.1c17.7.0 32 15.23 32 32 0 18.6-14.3 32-32 32H96c-17.67.0-32 15.2-32 32V416c0 17.7 14.33 32 32 32H352c17.7.0 32-14.3 32-32V319.1c0-16.8 14.3-32 32-32s32 15.2 32 32V416c0 53-43 96-96 96H96c-53.02.0-96-43-96-96V159.1c0-53 42.98-96 96-96h96z"/></svg></span></a></span></div><div class="my-1 text-xs leading-relaxed text-neutral-500 dark:text-neutral-400"><a href=/tags/nix/ class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">nix</a>
<a href=/tags/flakes/ class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">flakes</a>
<a href=/tags/nodejs/ class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">nodejs</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="-ms-5 block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="-ms-5 border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#the-application-in-question>The Application in question</a></li><li><a href=#packaging-the-application>Packaging the application</a><ul><li><a href=#it-all-starts-with-a-packagejson>It all starts with a <code>package.json</code></a></li><li><a href=#creating-the-derivation>Creating the derivation</a></li><li><a href=#testing-the-derivation>Testing the derivation</a></li></ul></li><li><a href=#using-the-derivation-from-within-a-flake>Using the derivation from within a Flake</a><ul><li><a href=#creating-an-overlay-package>Creating an overlay package</a></li><li><a href=#sharing-package-versions-with-flakelock>Sharing package versions with <code>flake.lock</code></a></li><li><a href=#bonus-wrapping-common-operations-in-a-makefile>Bonus: Wrapping common operations in a makefile</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose grow"><p>I recently rediscovered <a href=https://nixos.org/ target=_blank rel="noreferrer noopener">Nix</a>, the confusingly named trifecta of language, package manager, and build system (oh, and an operating system but at least it has a slightly distinct name!), after getting increasingly frustrated with the state of configuration management.</p><p>Colleagues of mine frequently get burned with builds failing because of mismatched versions of some specific package on their machine, or some specific flag that should have been enabled in some configuration file that wasn&rsquo;t documented anywhere.
Worse, I get burned managing multiple personal and work machines that always have slight differences between them.
I&rsquo;ve <a href=/posts/dotfiles/>tried to solve the latter before with Ansible</a> but little differences still pile up and making my Ansible configuration work on different operating systems and distributions becomes its own chore.
This isn&rsquo;t a post about me solving these issues specifically, but Nix might be part of the solution which has me very excited.</p><p>This isn&rsquo;t the first time Nix has made me excited.
Around a year ago I found out about Nix, got super excited about it and even replaced my primary dev machine&rsquo;s operating system with NixOS only to be inundated with incomplete documentation, weird compromises (mostly caused by fundamental misunderstandings over what Nix <strong>is</strong>), and a community split over the adoption of <a href=https://nixos.wiki/wiki/Flakes target=_blank rel="noreferrer noopener">Flakes</a>.
I quickly got lost and my productivity plummeted while I tried to figure out how to even get VSCode working properly.
To put a long story short, I put the cart before the horse and fell for the hype before even realizing what the hype was about.</p><p><em>This</em> time is different.
I&rsquo;ve decided to take things slowly this time and really understand Nix before fully committing to it.
Part of that commitment will be documenting my journey and all the pain-points I come across.</p><p>In this post I&rsquo;d like to share how I wrote my first overlay package in Nix, and some general tips I&rsquo;ve gathered surrounding overlays and Flakes.</p><h2 id=the-application-in-question class="relative group">The Application in question <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#the-application-in-question aria-label=Anchor>#</a></span></h2><p>The application in question is <a href=https://github.com/usnistgov/oscal-deep-diff target=_blank rel="noreferrer noopener">OSCAL-deep-diff</a>, a simple node application I built for work that compares large JSON documents.</p><p><em>Disclaimer: Although I am the author and current maintainer of OSCAL-deep-diff, and while I work on this project as part of my job, this is not an official package endorsed by my organization.</em></p><p>Packaging an application with Nix (especially with flakes) provides some really cool properties:</p><ul><li>You can reuse the package in other places easily (including other flakes).</li><li>If packaged properly, you can run the package from anywhere Nix is installed using <a href=https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-run.html target=_blank rel="noreferrer noopener"><code>nix run</code></a>.</li></ul><h2 id=packaging-the-application class="relative group">Packaging the application <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#packaging-the-application aria-label=Anchor>#</a></span></h2><p>Nix&rsquo;s build system is a complex patchwork of bash scripts and confusion as explained in <a href=https://jvns.ca/blog/2023/03/03/how-do-nix-builds-work-/ target=_blank rel="noreferrer noopener">this incredibly helpful article by Julia Evans</a>.
Thankfully Nix provides a lot of helpers that make packaging really simple.
Unfortunately, figuring out <em>how</em> to use these abstractions is another matter, as not a lot of examples exist online and documentation is sparse.
I managed to get my package working by dissecting examples like <a href=https://git.sr.ht/~bwolf/language-servers.nix/tree/master/item/vscode-langservers-extracted/default.nix target=_blank rel="noreferrer noopener">this</a>.</p><p>Hopefully this writeup will serve as a good starting point for people trying to package similar applications built on top of the NPM ecosystem.</p><h3 id=it-all-starts-with-a-packagejson class="relative group">It all starts with a <code>package.json</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#it-all-starts-with-a-packagejson aria-label=Anchor>#</a></span></h3><p>OSCAL-deep-diff, like many Typescript-based CLI applications that leverage the NPM ecosystem, is just a bunch of Typescript code that links to other Javascript code that makes up its many dependencies:</p><figure><img class="mx-auto my-0 rounded-md" alt loading=lazy src=/posts/packaging-node-applications-in-nix/images/oscal_oscal_deep_diff_dependencies.svg><figcaption class=text-center>OSCAL-deep-diff&rsquo;s dependency graph, generated via <a href="https://npmgraph.js.org/?q=%40oscal%2Foscal-deep-diff" target=_blank rel="noreferrer noopener">npmgraph.js</a></figcaption></figure><p>Lucky for me, all the &ldquo;building&rdquo; (compiling Typescript into Javascript) has already been done and all that my Nix derivation has to do is download all of the code and its dependencies, and stick it in the right place.</p><p>I&rsquo;m having <a href=https://yarnpkg.com/ target=_blank rel="noreferrer noopener">Yarn</a> do all of the heavy lifting of downloading the built Javascript code and resolve all of its dependencies.</p><p><em>NOTE: I chose to use Yarn instead of NPM here purely because it was the easiest for me to get working, your mileage may vary.</em></p><p>In my package directory I can create a <code>package.json</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// packages/oscal-deep-diff/package.json
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// My application is a single dependency
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// The version defined here will be the packaged application&#39;s version
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nt>&#34;@oscal/oscal-deep-diff&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// None of this matters, but yarn gets really angry if you omit it and things will break
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;oscal-deep-diff&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;license&#34;</span><span class=p>:</span> <span class=s2>&#34;NIST-PD-fallback&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Running <code>yarn</code> produces a lockfile containing the versions of all my package&rsquo;s dependencies, which can then be transformed into a Nix expression using <a href=https://nixos.org/manual/nixpkgs/stable/#yarn2nix target=_blank rel="noreferrer noopener"><code>yarn2nix</code></a>.</p><p>In Nix this is as easy as running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Run the command `yarn2nix` in an environment with the package `yarn2nix`</span>
</span></span><span class=line><span class=cl>$ nix-shell -p yarn2nix --command yarn2nix
</span></span></code></pre></div><p>I now have a <code>package.json</code>, <code>yarn.lock</code>, and <code>yarn.nix</code>, but how do I go about actually doing something useful with it?</p><h3 id=creating-the-derivation class="relative group">Creating the derivation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#creating-the-derivation aria-label=Anchor>#</a></span></h3><p>My Nix derivation needs to:</p><ol><li>Download all Javascript dependencies (the <code>node_modules/</code> folder) to the output folder.</li><li>Create a script that invokes my application&rsquo;s starting point.</li></ol><p>Step 1 is fairly easy using the <a href=https://nixos.org/manual/nixpkgs/stable/#mkYarnModules target=_blank rel="noreferrer noopener">mkYarnModules</a> helper.
The following Nix expression produces a derivation that downloads all our dependencies to a <code>node_modules/</code> folder:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Nix data-lang=Nix><span class=line><span class=cl><span class=c1># assuming the package name (pname), version, and nixpkgs as an input</span>
</span></span><span class=line><span class=cl><span class=n>pkgs</span><span class=o>.</span><span class=n>mkYarnModules</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>inherit</span> <span class=n>pname</span> <span class=n>version</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>packageJSON</span> <span class=o>=</span> <span class=sr>./package.json</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>yarnLock</span> <span class=o>=</span> <span class=sr>./yarn.lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>yarnNix</span> <span class=o>=</span> <span class=sr>./yarn.nix</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This fragment can be consumed in our final derivation (see the <code>deps</code> variable):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Nix data-lang=Nix><span class=line><span class=cl><span class=c1># packages/oscal-deep-diff/default.nix</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>pkgs</span> <span class=o>?</span> <span class=p>(</span><span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{})</span><span class=o>.</span><span class=n>pkgs</span> <span class=p>}:</span>
</span></span><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>pname</span> <span class=o>=</span> <span class=s2>&#34;oscal-deep-diff&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1># extract the version from package.json (ensuring these never get out of sync)</span>
</span></span><span class=line><span class=cl>  <span class=n>version</span> <span class=o>=</span> <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>fromJSON</span> <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>readFile</span> <span class=sr>./package.json</span><span class=p>))</span><span class=o>.</span><span class=n>dependencies</span><span class=o>.</span><span class=s2>&#34;@oscal/oscal-deep-diff&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1># grab our dependencies</span>
</span></span><span class=line><span class=cl>  <span class=n>deps</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>mkYarnModules</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>inherit</span> <span class=n>pname</span> <span class=n>version</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>packageJSON</span> <span class=o>=</span> <span class=sr>./package.json</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>yarnLock</span> <span class=o>=</span> <span class=sr>./yarn.lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>yarnNix</span> <span class=o>=</span> <span class=sr>./yarn.nix</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl><span class=n>pkgs</span><span class=o>.</span><span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>inherit</span> <span class=n>pname</span> <span class=n>version</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># No build dependencies, all work has been done for you already by mkYarnModules</span>
</span></span><span class=line><span class=cl>  <span class=n>nativeBuildInputs</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>[</span> <span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>buildInputs</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>[</span> <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Grab the dependencies from the above mkYarnModules derivation</span>
</span></span><span class=line><span class=cl>  <span class=n>configurePhase</span> <span class=o>=</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    mkdir -p $out/bin
</span></span></span><span class=line><span class=cl><span class=s1>    ln -s </span><span class=si>${</span><span class=n>deps</span><span class=si>}</span><span class=s1>/node_modules $out
</span></span></span><span class=line><span class=cl><span class=s1>  &#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Write a script to the output folder that invokes the entrypoint of the application</span>
</span></span><span class=line><span class=cl>  <span class=n>installPhase</span> <span class=o>=</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    cat &lt;&lt;EOF &gt; $out/bin/oscal-deep-diff
</span></span></span><span class=line><span class=cl><span class=s1>    #!</span><span class=si>${</span><span class=n>pkgs</span><span class=o>.</span><span class=n>nodejs</span><span class=si>}</span><span class=s1>/bin/node
</span></span></span><span class=line><span class=cl><span class=s1>    require(&#39;$out/node_modules/@oscal/oscal-deep-diff/lib/cli/cli.js&#39;);
</span></span></span><span class=line><span class=cl><span class=s1>    EOF
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    chmod a+x $out/bin/oscal-deep-diff
</span></span></span><span class=line><span class=cl><span class=s1>  &#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Skip the unpack step (mkDerivation will complain otherwise)  </span>
</span></span><span class=line><span class=cl>  <span class=n>dontUnpack</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In the configure phase the derivation creates a symbolic link to the <code>node_modules/</code> folder created from the <code>deps</code> variable (the <code>mkYarnModules</code> call)/</p><p>In the install phase the derivation produces a script that invokes the entrypoint of the application.
Also notice that the <a href=https://bash.cyberciti.biz/guide/Shebang target=_blank rel="noreferrer noopener">shebang</a> of the script points to <code>${pkgs.nodejs}/bin/node</code>, which is the version of node packaged by the <code>pkgs.nodejs</code> derivation.</p><h3 id=testing-the-derivation class="relative group">Testing the derivation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#testing-the-derivation aria-label=Anchor>#</a></span></h3><p>Building the derivation is as simple as running <code>nix-build</code>, which should produce an output folder <code>./result</code> containing our packaged script in <code>./result/bin</code> and all dependencies in <code>./result/node_modules</code>.</p><h2 id=using-the-derivation-from-within-a-flake class="relative group">Using the derivation from within a Flake <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#using-the-derivation-from-within-a-flake aria-label=Anchor>#</a></span></h2><h3 id=creating-an-overlay-package class="relative group">Creating an overlay package <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#creating-an-overlay-package aria-label=Anchor>#</a></span></h3><p><a href=https://nixos.wiki/wiki/Overlays target=_blank rel="noreferrer noopener">Nix overlays</a> are simple patterns that allow you to override your <code>nixpkgs</code> variable in order to add more packages or customize existing ones.
As of now I&rsquo;ve only had to do the former, thankfully it&rsquo;s pretty simple to do!</p><p>I started with a overlay that looked like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Nix data-lang=Nix><span class=line><span class=cl><span class=c1># packages/default.nix</span>
</span></span><span class=line><span class=cl><span class=n>final</span><span class=p>:</span> <span class=n>prev</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1># Import &#34;default.nix&#34; from the &#34;oscal-deep-diff&#34; directory</span>
</span></span><span class=line><span class=cl>  <span class=n>oscal-deep-diff</span> <span class=o>=</span> <span class=n>prev</span><span class=o>.</span><span class=n>callPackage</span> <span class=sr>./oscal-deep-diff</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This module can now be passed in as an argument wherever your import <code>nixpkgs</code>.</p><h3 id=sharing-package-versions-with-flakelock class="relative group">Sharing package versions with <code>flake.lock</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#sharing-package-versions-with-flakelock aria-label=Anchor>#</a></span></h3><p>Currently when we build our derivation with <code>nix-build</code>, the version of <code>nixpkgs</code> used by modules like <code>mkYarnModules</code> and <code>mkDerivation</code> is defined by the system channel, not the version defined in the flake.
This inconsistency is subtle but easily avoidable.</p><p>What if we used Nix&rsquo;s <a href=https://nixos.wiki/wiki/Overview_of_the_Nix_Language#Default_argument target=_blank rel="noreferrer noopener">default argument operator</a> to allow <code>pkgs</code> to be passed in when invoked through a flake, but if invoked through <code>nix-build</code> use the version of <code>nixpkgs</code> listed in the flake&rsquo;s lockfile?</p><p>It would look something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Nix data-lang=Nix><span class=line><span class=cl><span class=c1># packages/oscal-deep-diff/default.nix (fragment)</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>pkgs</span> <span class=o>?</span> <span class=k>let</span>
</span></span><span class=line><span class=cl>    <span class=c1># grab the lockfile and pull out the entry for `nixpkgs`</span>
</span></span><span class=line><span class=cl>    <span class=n>lock</span> <span class=o>=</span> <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>fromJSON</span> <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>readFile</span> <span class=sr>../../flake.lock</span><span class=p>))</span><span class=o>.</span><span class=n>nodes</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>locked</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs</span> <span class=o>=</span> <span class=nb>fetchTarball</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;https://github.com/nixos/nixpkgs/archive/</span><span class=si>${</span><span class=n>lock</span><span class=o>.</span><span class=n>rev</span><span class=si>}</span><span class=s2>.tar.gz&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>sha256</span> <span class=o>=</span> <span class=n>lock</span><span class=o>.</span><span class=n>narHash</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>in</span>
</span></span><span class=line><span class=cl>  <span class=kn>import</span> <span class=n>nixpkgs</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>,</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}:</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=n>pkgs</span><span class=o>.</span><span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span></code></pre></div><p>I use this pattern everywhere.
It makes it very easy to create dev shells with <a href=https://nixos.org/manual/nixpkgs/stable/#sec-pkgs-mkShell target=_blank rel="noreferrer noopener"><code>mkShell</code></a> that share a Flake&rsquo;s environment even when Flakes aren&rsquo;t enabled on the system.</p><h3 id=bonus-wrapping-common-operations-in-a-makefile class="relative group">Bonus: Wrapping common operations in a makefile <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bonus-wrapping-common-operations-in-a-makefile aria-label=Anchor>#</a></span></h3><p>I want to make operations like regenerating the <code>yarn.nix</code> file as painless as possible.
I do not want to have to remember to install <code>yarn</code>, <code>yarn2nix</code>, and run a specific set of commands to update the package version.</p><p>Thankfully, Nix makes this really easy using a dev shell.</p><p>First, in my <code>oscal-deep-diff</code> package directory I create a <code>shell.nix</code> containing all my dependencies:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Nix data-lang=Nix><span class=line><span class=cl><span class=c1># packages/oscal-deep-diff/shell.nix</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>pkgs</span> <span class=o>?</span>
</span></span><span class=line><span class=cl>  <span class=k>let</span>
</span></span><span class=line><span class=cl>    <span class=n>lock</span> <span class=o>=</span> <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>fromJSON</span> <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>readFile</span> <span class=sr>../../flake.lock</span><span class=p>))</span><span class=o>.</span><span class=n>nodes</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>locked</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs</span> <span class=o>=</span> <span class=nb>fetchTarball</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;https://github.com/nixos/nixpkgs/archive/</span><span class=si>${</span><span class=n>lock</span><span class=o>.</span><span class=n>rev</span><span class=si>}</span><span class=s2>.tar.gz&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>sha256</span> <span class=o>=</span> <span class=n>lock</span><span class=o>.</span><span class=n>narHash</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>in</span>
</span></span><span class=line><span class=cl>  <span class=kn>import</span> <span class=n>nixpkgs</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>,</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pkgs</span><span class=o>.</span><span class=n>mkShell</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>packages</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>nix</span>
</span></span><span class=line><span class=cl>    <span class=n>yarn</span>
</span></span><span class=line><span class=cl>    <span class=n>yarn2nix</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>I can enter this environment interactively with <code>nix-shell shell.nix</code>, but why do so when we can automate all operations using <code>make</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Makefile data-lang=Makefile><span class=line><span class=cl><span class=c># packages/oscal-deep-diff/Makefile
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>SHELL</span><span class=o>:=</span>/usr/bin/env bash
</span></span><span class=line><span class=cl><span class=nv>IN_NIXSHELL</span><span class=o>:=</span>nix-shell shell.nix --command
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>build</span> <span class=n>genlock</span> <span class=n>clean</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>build</span><span class=o>:</span> <span class=n>genlock</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>IN_NIXSHELL<span class=k>)</span> <span class=s1>&#39;nix-build&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>genlock</span><span class=o>:</span> <span class=n>yarn</span>.<span class=n>lock</span> <span class=n>yarn</span>.<span class=n>nix</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>yarn.lock</span><span class=o>:</span> <span class=n>package</span>.<span class=n>json</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>IN_NIXSHELL<span class=k>)</span> <span class=s1>&#39;yarn install --mode update-lockfile&#39;</span>
</span></span><span class=line><span class=cl>	rm -fr node_modules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>yarn.nix</span><span class=o>:</span> <span class=n>yarn</span>.<span class=n>lock</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>IN_NIXSHELL<span class=k>)</span> <span class=s1>&#39;yarn2nix &gt; yarn.nix&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm -fr result yarn.*
</span></span></code></pre></div><p>Notice, that all targets are running <em>inside</em> the Nix shell environment defined earlier.
That means that if I want to update the package, all I have to do is run <code>make</code>, even if I&rsquo;m not in an environment that has <code>yarn</code> installed.</p><h2 id=conclusion class="relative group">Conclusion <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#conclusion aria-label=Anchor>#</a></span></h2><p>I hope this little retrospective helps you navigate Nix a little easier!</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full" width=96 height=96 alt="Nikita Wootten" src=/img/lucya_huff674df71d5f4b525de779cc99124df9_346497_192x192_fill_box_center_3.png loading=lazy><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Nikita Wootten</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=mailto:stdin@nikita.computer target=_blank aria-label=Email rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/nikitawootten target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://www.linkedin.com/in/nikita-wootten/ target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://mstdn.social/@nikitaw target=_blank aria-label=Mastodon rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></span></a></div></div></div></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://tootpick.org/#text=https://nikita.computer/posts/packaging-node-applications-in-nix/%20Packaging%20Node%20Applications%20in%20Nix%20using%20Yarn2Nix" title="Toot on Mastodon" aria-label="Toot on Mastodon" target=_blank rel="noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://nikita.computer/posts/packaging-node-applications-in-nix/&amp;resubmit=true&amp;title=Packaging%20Node%20Applications%20in%20Nix%20using%20Yarn2Nix" title="Submit to Reddit" aria-label="Submit to Reddit" target=_blank rel="noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg></span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://nikita.computer/posts/packaging-node-applications-in-nix/&amp;title=Packaging%20Node%20Applications%20in%20Nix%20using%20Yarn2Nix" title="Share on LinkedIn" aria-label="Share on LinkedIn" target=_blank rel="noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://nikita.computer/posts/packaging-node-applications-in-nix/&amp;subject=Packaging%20Node%20Applications%20in%20Nix%20using%20Yarn2Nix" title="Send via email" aria-label="Send via email" target=_blank rel="noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/hugo-openring/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Configuring my Congo themed Hugo blog to use Openring</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-12-03 18:26:40 -0500 -0500">3 December 2022</time></span></span></a></span>
<span><a class="group flex text-right" href=/posts/makefile-tips/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Tips for using Makefiles in your projects</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-07-07 21:54:43 -0400 -0400">7 July 2023</time></span></span>
<span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=nikitawootten/nikitawootten.github.io data-repo-id=R_kgDOHRFEvA data-category=Article data-category-id=DIC_kwDOHRFEvM4CTkK0 data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></footer></article></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">The content for this site is <a href=https://creativecommons.org/licenses/by/2.0/ target=_blank rel="noreferrer noopener">CC-BY 2.0</a>, the <a href=https://github.com/nikitawootten/nikitawootten.github.io target=_blank rel="noreferrer noopener">code</a> is <a href=https://github.com/nikitawootten/nikitawootten.github.io/blob/main/LICENSE target=_blank rel="noreferrer noopener">MIT</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div></div><div class=mt-6><section class=webring><h3>Articles from blogs I follow around the net:</h3><section class="flex flex-wrap"><div class="article flex flex-col m-1 p-1 bg-neutral-300 dark:bg-neutral-600"><h4 class=m-0><a href=https://pluralistic.net/2024/01/27/here-comes-the-sun-king/ target=_blank rel=noopener>Pluralistic: Solar is a market for (financial) lemons (27 Jan 2024)</a></h4><p class=summary>Today's links Solar is a market for (financial) lemons: Our Slow AIs have an alignment problem. Hey look at this: Delights to delectate. This day in history: 2004, 2009, 2014, 2019 Colophon: Recent publications, upcoming/recent appearances, current wr</p><small>via <a href=https://pluralistic.net>Pluralistic: Daily links from Cory Doctorow</a></small>
<small>January 27, 2024</small></div><div class="article flex flex-col m-1 p-1 bg-neutral-300 dark:bg-neutral-600"><h4 class=m-0><a href=https://jvns.ca/blog/2024/01/26/inside-git/ target=_blank rel=noopener>Inside .git</a></h4><p class=summary>Hello! I posted a comic on Mastodon this week about whats in the .git
directory and someone requested a text version, so here it is. I added some
extra notes too. First, heres the image. Its a ~15 word explanation of each
part of your .git directory.
You c</p><small>via <a href=http://jvns.ca>Julia Evans</a></small>
<small>January 26, 2024</small></div><div class="article flex flex-col m-1 p-1 bg-neutral-300 dark:bg-neutral-600"><h4 class=m-0><a href=https://xn--gckvb8fzb.com/a-brief-review-of-the-star-labs-starbook-mk-vi-ryzen-ultrabook/ target=_blank rel=noopener>A Brief Review of the Star Labs StarBook Mk VI Ryzen Ultrabook</a></h4><p class=summary>As announced back in the [update of Q4/2023](/updates-2023-q4), I went ahead
and ordered a Star Labs StarBook Mk VI with an AMD Ryzen processor to finally
replace my [previous laptop](/computer/#d3lt4) and eventually my
[workstation](/computer/#cbrspc7). Thi</p><small>via <a href=https://xn--gckvb8fzb.com/></a></small>
<small>January 25, 2024</small></div></section><p class="text-sm text-neutral-500 dark:text-neutral-400 text-right">Generated by
<a href=https://git.sr.ht/~sircmpwn/openring>openring</a></p></section><style>.webring .article{flex:1;min-width:10rem}.webring .summary{flex:1;font-size:.8rem}</style></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://nikita.computer/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>